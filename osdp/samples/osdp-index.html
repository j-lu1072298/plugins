<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1" name="viewport" />
    <title>Plugin: OSDP</title>

    <style>
        body {
            display: flex;
            flex-direction: column;
        }

        .myMap {
            height: 80%;
        }

        input,
        label {
            padding: 5px;
            margin: 12px;
        }

        input {
            width: 18%;
        }
    </style>

    <link rel="stylesheet" href="/rv-styles.css" />
    <script src="../osdp.js"></script>
    <script type="text/javascript">
        var ck_strarray = /^\[[+-]?\d+(\.\d+)?\,+[+-]?\d+(\.\d+)?\]$/
        function validate(values) {
            var strarray = values;
            var errors = [];

            debugger
            if (!ck_strarray.test(strarray)) {
                errors[errors.length] = "You must enter a valid array [123.55,321.66]";
            }

            if (errors.length > 0) {
                reportErrors(errors);
                return false;
            }

            return true;
        }

        function reportErrors(errors) {
            var msg = "Please Enter Valide Data...\n";
            for (var i = 0; i < errors.length; i++) {
                var numError = i + 1;
                msg += "\n" + numError + ". " + errors[i];
            }
            alert(msg);
        }
    </script>
</head>

<body>
    <div class="myMap" id="mapOSDP" is="rv-map" rv-config="osdp-config.json" rv-langs='["en-CA", "fr-CA"]'
        rv-plugins="osdp" rv-service-endpoint="https://rcs.open.canada.ca">
        <noscript>
            <p>
                This interactive map requires JavaScript. To view this content please enable JavaScript in your
                browser or download a browser that supports it.
            </p>
            <p></p>

            <p>
                Cette carte interactive nécessite JavaScript. Pour voir ce contenu, s'il vous plaît, activer
                JavaScript dans votre navigateur ou télécharger un navigateur qui le prend en charge.
            </p>
        </noscript>
    </div>

    <div>
        <!-- get the extent box section -->
        <button type="button" onclick="displayExtentBox()">Get Extent Box</button>
        <label id="extbbox"></label>
    </div>

    <div>
        <!-- zoom lat\long section -->
        <input type="text" id="zoomPt" name="zoomPt" value="[-112.92, 53.8]"></input>
        <button type="button" onclick="zoomPt()">Zoom Lat\Long</button>

        <!-- zoom polygon section section -->
        <input type="text" id="zoomPoly" name="zoomPoly"
            value="[[-128.75, 53.8],[-128.75, 53.92],[-112.92, 53.92],[-112.92, 53.8],[-128.75, 53.8]]"></input>
        <button type="button" onclick="zoomPoly()">Zoom Polygon</button>
    </div>

    <div>
        <!-- set defintiion query section -->
        <label for="layerId">Layer Id</label>
        <input type="text" id="layerId" list="layersList" name="layers" onfocus="this.value=''"></input>
        <datalist id="layersList">
            <option value="rcs.e313db89-4219-4a5e-a543-772a86068710.en">
            <option value="rcs.35c51098-5cd8-44b0-b1cd-c8ce2f5dae89.en">
        </datalist>
        <label for="query">Query</label>
        <input id="query" type="text" name="query" value="Longitude<-110" onfocus="this.value=''"></input>
        <button type="button"
            onclick="window.osdp.setDefinitonQuery('mapOSDP', document.getElementById('layerId').value, document.getElementById('query').value)">Set
            def query</button>
        <button type="button"
            onclick="window.osdp.resetDefinitionQuery('mapOSDP', document.getElementById('layerId').value)">Reset def
            query</button>
    </div>

    <div>
        <!-- add layer by uuid section -->
        <label for="addLayerUUID">UUID</label>
        <input id="addLayerUUID" type="text" list="rcsList" name="layer" onfocus="this.value=''"></input>
        <datalist id="rcsList">
            <option value="3d282116-e556-400c-9306-ca1a3cada77f">
            <option value="b6b6d5a6-bded-4b6e-9e8a-17f6e1b538dc">
            <option value="7796058d-507f-4b6d-b169-8c6af60c5916">
        </datalist>
        <button type="button" onclick="window.osdp.addLayerByUUID(document.getElementById('addLayerUUID').value)">Add
            Layer</button>
        <label id="nbLayer"></label>
        <button type="button" onclick="window.osdp.addLayerByConfig('mapOSDP', {})">Add Layer by Config</button>
    </div>

    <div>
        <!-- Add geometry-->
        <label for="addPoints">Points</label>
        <input id="addPoints" type="text" list="pointslist" name="pointsgeom" onfocus="this.value=''"></input>
        <datalist id="pointslist">
            <option value="[-75,43]">
            <option value="[[-80, 55],[-60, 45]]">
        </datalist>
        <button type="button"
            onclick="window.osdp.addPointsGeometry('mapOSDP', document.getElementById('addPoints').value)">Add
            Points</button>
        <button type="button" onclick="window.osdp.removeGeometries('mapOSDP')">Remove Geometries</button>
    </div>
    <div>
        <!-- Add polygon-->
        <label for="addPolygon">Polygon</label>
        <input id="addPolygon" type="text" list="polygonlist" name="polyg" onfocus="this.value=''"></input>
        <datalist id="polygonlist">
            <option value=" [[-74, 45], [-74, 46], [-71, 46], [-71, 45], [-74, 45]]">
            <option
                value="[[[-77.19,44.93],[-76.86,47.219],[-71.43,47.769],[-72.971,44.556],[-77.19,44.93]],[[-74, 45], [-74, 46], [-71, 46], [-71, 45], [-74, 45]]]">
        </datalist>
        <button type="button"
            onclick="window.osdp.addPolygonsGeometry('mapOSDP', document.getElementById('addPolygon').value)">Add
            Geometry</button>
        <button type="button" onclick="window.osdp.removeGeometries('mapOSDP')">Remove Geometries</button>
    </div>
    <div>
        <!-- save and load state section -->
        <button type="button"
            onclick="window.osdp.saveState('mapOSDPBuilder'); window.open('http://localhost:6001/osdp/samples/osdp-builder.html');">Open
            Builder</button>
    </div>

    <p>Note: To make this work properly for the builder, layer id must be the catalogue id (e.g. rcs.myid.en or
        rcs.myid.fr). This way, bookmark engine recognize the layer and load it. Should be use only with autopopulate
        legend.</p>
    <p>Note: You can't remove layers from a structure legend. To have the remove button, you need autopopulate type.</p>
    <script
        src="https://cdn.polyfill.io/v2/polyfill.min.js?features=default,Object.entries,Object.values,Array.prototype.find,Array.prototype.findIndex,Array.prototype.values,Array.prototype.includes,HTMLCanvasElement.prototype.toBlob,String.prototype.repeat,String.prototype.codePointAt,String.fromCodePoint,NodeList.prototype.@@iterator,Promise,Promise.prototype.finally"></script>
    <script src="/legacy-api.js"></script>
    <script src="/rv-main-test.js"></script>
</body>

<script>
    window.osdp.layersEvents(layer => {
        document.getElementById('nbLayer').innerHTML = `layers: ${layer._mapInstance._layerRecords.length}`;
    });

    function displayExtentBox() {
        var extbox = window.osdp.getExtentBox();
        document.getElementById('extbbox').innerText = `[${JSON.stringify(extbox.northEast)}, ${JSON.stringify(extbox.southWest)}]`;
    }

    function zoomPt() {
        window.osdp.zoomPt('mapOSDP', document.getElementById('zoomPt').value);
    }

    function zoomPoly() {
        window.osdp.zoomPoly('mapOSDP', document.getElementById('zoomPoly').value);
    }

    // link to api from script
    RAMP.mapAdded.subscribe(mapi => {
        console.log('map');
    });
</script>

</html>