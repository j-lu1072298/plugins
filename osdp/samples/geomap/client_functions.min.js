/*
 * @title WET-BOEW Geomap client functions
 * @overview OpenLayers popup loader for Geomap
 * @license wet-boew.github.io/wet-boew/License-en.html / wet-boew.github.io/wet-boew/Licence-fr.html
 * @author @pjackson28
 */
( function( $, wb ) {
"use strict";

var $document = wb.doc,
	mapSample;

$document.on( "wb-ready.wb-geomap", "#sample_map", function( event, map ) {

	console.log('in');

	// Get the sample_map to use in zoomFeature function
	mapSample = map;
	var $aoiExtent = $( "#geomap-aoi-extent-" + mapSample.id ),
		$aoiExtentLonLat = $( "#geomap-aoi-extent-lonlat-" + mapSample.id ),
		$inputLocation = $( "#wb-geomap-geocode-search-" + mapSample.id),
		removeExtent = false;

	map.on('moveend', function(evt) {
		//setTimeout(function() { getLayerById(map, "locLayer").getSource().clear( true ); }, 1500);
		if (removeExtent) { getLayerById(map, "locLayer").getSource().clear( true ); }
		removeExtent = false;

		var extent = getExtent(map);
		console.log("BBox from extent event: " + extent);
	});

	$inputLocation.on( "change", function() {
		var extent = getExtent(map);
		removeExtent = true;
		console.log("BBox from location: " + extent);
	});

	if ( $aoiExtent ) {

		$aoiExtent.on( "change", function() {
			var extent = getExtent(map); //closureFunc(getExtent(map));
			console.log( "BBox from draw: " + extent);
		} );

		$aoiExtentLonLat.on( "change", function() {
			var extent = getExtent(map);
			console.log( "BBox from input: " + extent);
		} );
	}
} );

function getLayerById( map, id ) {
	var layer;

	map.getLayers().forEach( function( lyr ) {
		if ( id === lyr.id ) {
			layer = lyr;
			return;
		}
	} );

	return layer;
}

function getExtent(map) {
	var projLatLon = new ol.proj.Projection( { code: "EPSG:4326" } );
	var projMap = map.getView().getProjection();

	var extent = map.getView().calculateExtent(map.getSize());
	var latlongExtent = ol.proj.transformExtent(extent, projMap, projLatLon);

	return latlongExtent;
}

} )( jQuery, wb );
